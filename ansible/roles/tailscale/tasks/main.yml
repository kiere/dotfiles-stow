---
# Tailscale VPN installation
# Supports: Fedora, Ubuntu/Pop!_OS, Arch Linux/CachyOS

# Fedora - add Tailscale repo
- name: Setup Tailscale (Fedora)
  when: ansible_distribution in distros_fedora
  become: true
  block:
    - name: Add Tailscale repository
      ansible.builtin.get_url:
        url: "{{ repo_tailscale }}"
        dest: /etc/yum.repos.d/tailscale.repo
        mode: '0644'

    - name: Install Tailscale
      ansible.builtin.dnf:
        name: tailscale
        state: present

# Ubuntu/Pop!_OS - add Tailscale apt repo
- name: Setup Tailscale (Ubuntu/Pop!_OS)
  when: ansible_distribution in distros_debian
  become: true
  block:
    - name: Add Tailscale GPG key
      ansible.builtin.get_url:
        url: https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg
        dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
        mode: '0644'

    - name: Add Tailscale repository
      ansible.builtin.apt_repository:
        repo: >-
          deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg]
          https://pkgs.tailscale.com/stable/ubuntu {{ ansible_distribution_release }} main
        state: present
        filename: tailscale

    - name: Install Tailscale
      ansible.builtin.apt:
        name: tailscale
        state: present
        update_cache: true

# Arch - Tailscale in official repos
- name: Install Tailscale (Arch)
  ansible.builtin.package:
    name: "{{ pkg_tailscale }}"
    state: present
  become: true
  when: ansible_distribution in distros_arch

- name: Enable and start Tailscale service
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started
  become: true

- name: Display Tailscale installation complete
  ansible.builtin.debug:
    msg: |
      Tailscale installed!

      To connect: sudo tailscale up
      To check status: tailscale status
