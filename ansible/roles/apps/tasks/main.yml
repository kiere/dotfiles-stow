---
# Native desktop applications installation
# Supports: Fedora, Ubuntu/Pop!_OS, Arch Linux/CachyOS

# Desktop apps from standard repos (pinta, evince, obs-studio)
- name: Install desktop apps from package manager
  ansible.builtin.package:
    name: "{{ pkg_desktop_apps }}"
    state: present
  become: true

# ============================================================
# 1Password - different setup per distro
# ============================================================

# Fedora - add 1Password repo
- name: Setup 1Password (Fedora)
  when: ansible_distribution in distros_fedora
  become: true
  block:
    - name: Import 1Password GPG key
      ansible.builtin.rpm_key:
        key: "{{ repo_1password_key }}"
        state: present

    - name: Add 1Password repository
      ansible.builtin.yum_repository:
        name: 1password
        description: 1Password Stable Channel
        baseurl: https://downloads.1password.com/linux/rpm/stable/$basearch
        gpgcheck: true
        gpgkey: "{{ repo_1password_key }}"
        enabled: true
        repo_gpgcheck: true

    - name: Install 1Password
      ansible.builtin.dnf:
        name:
          - 1password
          - 1password-cli
        state: present

# Ubuntu/Pop!_OS - add 1Password apt repo
- name: Setup 1Password (Ubuntu/Pop!_OS)
  when: ansible_distribution in distros_debian
  become: true
  block:
    - name: Add 1Password GPG key
      ansible.builtin.get_url:
        url: https://downloads.1password.com/linux/keys/1password.asc
        dest: /usr/share/keyrings/1password-archive-keyring.asc
        mode: '0644'

    - name: Convert 1Password GPG key
      ansible.builtin.command:
        cmd: gpg --dearmor -o /usr/share/keyrings/1password-archive-keyring.gpg /usr/share/keyrings/1password-archive-keyring.asc
        creates: /usr/share/keyrings/1password-archive-keyring.gpg

    - name: Add 1Password repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/amd64 stable main"
        state: present
        filename: 1password

    - name: Install 1Password
      ansible.builtin.apt:
        name:
          - 1password
          - 1password-cli
        state: present
        update_cache: true

# Arch - 1Password from AUR with GPG verification
- name: Setup 1Password (Arch)
  when: ansible_distribution in distros_arch
  block:
    - name: Import 1Password GPG key for AUR verification
      ansible.builtin.command:
        cmd: gpg --keyserver keyserver.ubuntu.com --recv-keys {{ onepassword_gpg_fingerprint }}
      changed_when: false
      failed_when: false

    - name: Install 1Password from AUR
      kewlfft.aur.aur:
        name:
          - 1password
          - 1password-cli
        state: present

# ============================================================
# VSCode - different setup per distro (or use Flatpak)
# ============================================================

- name: Setup VSCode (Fedora)
  when: ansible_distribution in distros_fedora
  become: true
  block:
    - name: Import Microsoft GPG key
      ansible.builtin.rpm_key:
        key: "{{ repo_vscode_key }}"
        state: present

    - name: Add VSCode repository
      ansible.builtin.yum_repository:
        name: vscode
        description: Visual Studio Code
        baseurl: https://packages.microsoft.com/yumrepos/vscode
        gpgcheck: true
        gpgkey: "{{ repo_vscode_key }}"
        enabled: true

    - name: Install VSCode
      ansible.builtin.dnf:
        name: code
        state: present

- name: Setup VSCode (Ubuntu/Pop!_OS)
  when: ansible_distribution in distros_debian
  become: true
  block:
    - name: Add Microsoft GPG key
      ansible.builtin.get_url:
        url: https://packages.microsoft.com/keys/microsoft.asc
        dest: /usr/share/keyrings/microsoft-archive-keyring.asc
        mode: '0644'

    - name: Convert Microsoft GPG key
      ansible.builtin.command:
        cmd: gpg --dearmor -o /usr/share/keyrings/microsoft-archive-keyring.gpg /usr/share/keyrings/microsoft-archive-keyring.asc
        creates: /usr/share/keyrings/microsoft-archive-keyring.gpg

    - name: Add VSCode repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-archive-keyring.gpg] https://packages.microsoft.com/repos/vscode stable main"
        state: present
        filename: vscode

    - name: Install VSCode
      ansible.builtin.apt:
        name: code
        state: present
        update_cache: true

- name: Install VSCode from AUR (Arch)
  kewlfft.aur.aur:
    name: visual-studio-code-bin
    state: present
  when: ansible_distribution in distros_arch

# ============================================================
# Brave Browser
# ============================================================

- name: Setup Brave Browser (Fedora)
  when: ansible_distribution in distros_fedora
  become: true
  block:
    - name: Import Brave GPG key
      ansible.builtin.rpm_key:
        key: "{{ repo_brave_key }}"
        state: present

    - name: Add Brave repository
      ansible.builtin.get_url:
        url: "{{ repo_brave_repo }}"
        dest: /etc/yum.repos.d/brave-browser.repo
        mode: '0644'

    - name: Install Brave
      ansible.builtin.dnf:
        name: brave-browser
        state: present

- name: Setup Brave Browser (Ubuntu/Pop!_OS)
  when: ansible_distribution in distros_debian
  become: true
  block:
    - name: Add Brave GPG key
      ansible.builtin.get_url:
        url: https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
        dest: /usr/share/keyrings/brave-browser-archive-keyring.gpg
        mode: '0644'

    - name: Add Brave repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main"
        state: present
        filename: brave-browser

    - name: Install Brave
      ansible.builtin.apt:
        name: brave-browser
        state: present
        update_cache: true

# Arch has brave-bin in AUR or brave-browser in chaotic-aur
- name: Install Brave from package manager (Arch)
  ansible.builtin.package:
    name: "{{ pkg_brave }}"
    state: present
  become: true
  when: ansible_distribution in distros_arch

# ============================================================
# Dropbox (native for Nautilus/tray integration)
# ============================================================

- name: Install Dropbox (Fedora)
  ansible.builtin.dnf:
    name: dropbox
    state: present
  become: true
  when: ansible_distribution in distros_fedora

# Ubuntu/Debian - download from Dropbox directly
- name: Install Dropbox dependencies (Ubuntu/Pop!_OS)
  ansible.builtin.apt:
    name:
      - python3-gpg
      - libpango-1.0-0
    state: present
  become: true
  when: ansible_distribution in distros_debian

- name: Download and install Dropbox (Ubuntu/Pop!_OS)
  ansible.builtin.apt:
    deb: https://linux.dropbox.com/packages/ubuntu/dropbox_2024.04.17_amd64.deb
    state: present
  become: true
  when: ansible_distribution in distros_debian
  # Note: Check https://www.dropbox.com/install-linux for latest version if this fails

# Arch - dropbox from AUR
- name: Install Dropbox from AUR (Arch)
  kewlfft.aur.aur:
    name: dropbox
    state: present
  when: ansible_distribution in distros_arch

- name: Display apps installation complete
  ansible.builtin.debug:
    msg: |
      Native apps installed:
      - 1Password + CLI
      - VSCode
      - Brave Browser
      - Dropbox
      - Desktop apps (pinta, evince, obs-studio)
