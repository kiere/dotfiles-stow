---
# GNU Stow installation and dotfiles application
# Supports: Fedora, Ubuntu/Pop!_OS, Arch Linux/CachyOS

- name: Install stow and git
  ansible.builtin.package:
    name: "{{ pkg_stow }}"
    state: present
  become: true

- name: Check if dotfiles directory exists
  ansible.builtin.stat:
    path: "{{ dotfiles_dir }}"
  register: stow_dotfiles_check

- name: Warn if dotfiles directory not found
  ansible.builtin.debug:
    msg: "Warning: Dotfiles directory {{ dotfiles_dir }} not found. Clone your dotfiles repo first."
  when: not stow_dotfiles_check.stat.exists

- name: Stow packages
  when: stow_dotfiles_check.stat.exists
  block:
    - name: Set backup timestamp
      ansible.builtin.set_fact:
        stow_backup_suffix: ".bak.{{ ansible_date_time.iso8601_basic_short }}"

    - name: Find top-level targets in each stow package
      ansible.builtin.find:
        paths: "{{ dotfiles_dir }}/{{ item }}"
        file_type: any
        hidden: true
        recurse: false
      loop: "{{ stow_packages }}"
      register: stow_package_contents
      failed_when: false

    - name: Build list of target paths
      ansible.builtin.set_fact:
        stow_targets: >-
          {{
            stow_targets | default([]) +
            (item.files | default([]) | map(attribute='path') |
             map('regex_replace', '^' + dotfiles_dir + '/[^/]+', user_home) | list)
          }}
      loop: "{{ stow_package_contents.results }}"
      when: item.files is defined

    - name: Check which targets exist and are not symlinks
      ansible.builtin.stat:
        path: "{{ item }}"
      loop: "{{ stow_targets | default([]) | unique }}"
      register: stow_target_stats

    - name: Rename conflicting items in place
      ansible.builtin.command:
        cmd: mv "{{ item.stat.path }}" "{{ item.stat.path }}{{ stow_backup_suffix }}"
      loop: "{{ stow_target_stats.results }}"
      when:
        - item.stat.exists | default(false)
        - not (item.stat.islnk | default(false))
      changed_when: true
      loop_control:
        label: "{{ item.item }}"

    - name: Ensure directories exist (prevents stow folding)
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ user_home }}/.local/bin"
        - "{{ user_home }}/.claude"
        - "{{ user_home }}/.var/app/it.mijorus.gearlever/config"

    - name: Apply stow packages
      ansible.builtin.command:
        cmd: stow -v -d {{ dotfiles_dir }} -t {{ user_home }} {{ item }}
      loop: "{{ stow_packages }}"
      register: stow_result
      changed_when: "'LINK' in stow_result.stderr"
      failed_when: false

    - name: Display stow results
      ansible.builtin.debug:
        msg: |
          Stow packages applied from {{ dotfiles_dir }}:
          {% for pkg in stow_packages %}
          - {{ pkg }}
          {% endfor %}

          Conflicting items were renamed with {{ stow_backup_suffix }} suffix.
