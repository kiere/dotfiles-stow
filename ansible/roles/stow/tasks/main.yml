---
# GNU Stow installation and dotfiles application
# Supports: Fedora, Ubuntu/Pop!_OS, Arch Linux/CachyOS

- name: Install stow and git
  ansible.builtin.package:
    name: "{{ pkg_stow }}"
    state: present
  become: true

- name: Check if dotfiles directory exists
  ansible.builtin.stat:
    path: "{{ dotfiles_dir }}"
  register: dotfiles_check

- name: Apply stow packages
  ansible.builtin.command:
    cmd: stow -v -d {{ dotfiles_dir }} -t {{ user_home }} {{ item }}
  loop: "{{ stow_packages }}"
  register: stow_result
  changed_when: "'LINK' in stow_result.stderr"
  failed_when: false  # Don't fail if package doesn't exist
  when: dotfiles_check.stat.exists

- name: Display stow results
  ansible.builtin.debug:
    msg: |
      Stow packages applied from {{ dotfiles_dir }}:
      {% for pkg in stow_packages %}
      - {{ pkg }}
      {% endfor %}

      Note: Existing files may need manual resolution if conflicts occur.
  when: dotfiles_check.stat.exists

- name: Warn if dotfiles directory not found
  ansible.builtin.debug:
    msg: "Warning: Dotfiles directory {{ dotfiles_dir }} not found. Clone your dotfiles repo first."
  when: not dotfiles_check.stat.exists
