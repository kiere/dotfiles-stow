---
# TablePlus database GUI installation
# Fedora: dnf repo, Ubuntu/Pop!_OS: apt repo, Arch: AppImage fallback

# ============================================================
# Fedora - native dnf repository
# ============================================================
- name: Setup TablePlus (Fedora)
  when: ansible_facts['distribution'] in distros_fedora
  become: true
  block:
    - name: Add TablePlus repository (Fedora x86_64)
      ansible.builtin.get_url:
        url: https://yum.tableplus.com/rpm/x86_64/tableplus.repo
        dest: /etc/yum.repos.d/tableplus.repo
        mode: "0644"
      when: ansible_facts['architecture'] == "x86_64"

    - name: Add TablePlus repository (Fedora ARM64)
      ansible.builtin.get_url:
        url: https://yum.tableplus.com/rpm/arm64/tableplus.repo
        dest: /etc/yum.repos.d/tableplus.repo
        mode: "0644"
      when: ansible_facts['architecture'] == "aarch64"

    - name: Install TablePlus (Fedora)
      ansible.builtin.dnf:
        name: tableplus
        state: present

# ============================================================
# Ubuntu/Pop!_OS - native apt repository
# ============================================================
- name: Setup TablePlus (Ubuntu/Pop!_OS)
  when: ansible_facts['distribution'] in distros_debian
  become: true
  block:
    - name: Add TablePlus GPG key
      ansible.builtin.get_url:
        url: https://deb.tableplus.com/apt.tableplus.com.gpg.key
        dest: /etc/apt/keyrings/tableplus-archive-keyring.asc
        mode: "0644"

    - name: Convert TablePlus GPG key
      ansible.builtin.command:
        cmd: gpg --dearmor -o /etc/apt/keyrings/tableplus-archive-keyring.gpg /etc/apt/keyrings/tableplus-archive-keyring.asc
        creates: /etc/apt/keyrings/tableplus-archive-keyring.gpg

    - name: Determine Ubuntu version for TablePlus repo
      ansible.builtin.set_fact:
        tableplus_ubuntu_version: >-
          {{ '24' if ansible_facts['distribution_major_version'] | int >= 24
             else '22' if ansible_facts['distribution_major_version'] | int >= 22
             else '20' }}

    - name: Add TablePlus repository (Ubuntu x86_64)
      ansible.builtin.apt_repository:
        repo: >-
          deb [arch=amd64 signed-by=/etc/apt/keyrings/tableplus-archive-keyring.gpg]
          https://deb.tableplus.com/debian/{{ tableplus_ubuntu_version }} tableplus main
        state: present
        filename: tableplus
      when: ansible_facts['architecture'] == "x86_64"

    - name: Add TablePlus repository (Ubuntu ARM64)
      ansible.builtin.apt_repository:
        repo: >-
          deb [arch=arm64 signed-by=/etc/apt/keyrings/tableplus-archive-keyring.gpg]
          https://deb.tableplus.com/debian/{{ tableplus_ubuntu_version }}-arm tableplus main
        state: present
        filename: tableplus
      when: ansible_facts['architecture'] == "aarch64"

    - name: Install TablePlus (Ubuntu)
      ansible.builtin.apt:
        name: tableplus
        state: present
        update_cache: true

# ============================================================
# Arch - AppImage fallback (AUR package is unreliable)
# ============================================================
- name: Setup TablePlus AppImage (Arch)
  when: ansible_facts['distribution'] in distros_arch
  block:
    - name: Create Applications directory
      ansible.builtin.file:
        path: "{{ user_home }}/Applications"
        state: directory
        mode: "0755"

    - name: Download TablePlus AppImage (x86_64)
      ansible.builtin.get_url:
        url: https://tableplus.com/release/linux/x64/TablePlus-x64.AppImage
        dest: "{{ user_home }}/Applications/TablePlus.AppImage"
        mode: "0755"
      when: ansible_facts['architecture'] == "x86_64"

    - name: Download TablePlus AppImage (ARM64)
      ansible.builtin.get_url:
        url: https://tableplus.com/release/linux/arm64/TablePlus-aarch64.AppImage
        dest: "{{ user_home }}/Applications/TablePlus.AppImage"
        mode: "0755"
      when: ansible_facts['architecture'] == "aarch64"

    - name: Create TablePlus desktop entry (Arch)
      ansible.builtin.copy:
        dest: "{{ user_home }}/.local/share/applications/tableplus.desktop"
        mode: "0644"
        content: |
          [Desktop Entry]
          Name=TablePlus
          Comment=Modern database GUI
          Exec={{ user_home }}/Applications/TablePlus.AppImage %U
          Terminal=false
          Type=Application
          Categories=Development;Database;
          StartupWMClass=TablePlus
          MimeType=x-scheme-handler/tableplus;x-scheme-handler/tableplusapi;

- name: Display TablePlus installation complete
  ansible.builtin.debug:
    msg: |
      TablePlus installed!
      {% if ansible_facts['distribution'] in distros_arch %}
      Note: Using AppImage on Arch (AUR package is unreliable).
      AppImage saved to ~/Applications/TablePlus.AppImage
      {% else %}
      Installed via native package manager with automatic updates.
      {% endif %}
