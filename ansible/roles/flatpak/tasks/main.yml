---
# Flatpak setup and app installation
# Supports: Fedora, Ubuntu/Pop!_OS, Arch Linux/CachyOS

- name: Install Flatpak
  ansible.builtin.package:
    name: flatpak
    state: present
  become: true

# Fedora ships with a filtered Flathub - remove it and add the full one
- name: Remove filtered Flathub remote (Fedora)
  ansible.builtin.command:
    cmd: flatpak remote-delete --system flathub --force
  become: true
  failed_when: false
  changed_when: false
  when: ansible_facts['distribution'] in distros_fedora

- name: Add full Flathub repository (system-wide)
  community.general.flatpak_remote:
    name: flathub
    flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
    state: present
    method: system
  become: true

- name: Install Flatpak apps (system-wide)
  community.general.flatpak:
    name: "{{ item }}"
    state: present
    method: system
  become: true
  loop: "{{ flatpak_apps }}"
  register: flatpak_result
  failed_when: false

- name: Report unavailable Flatpak apps
  ansible.builtin.debug:
    msg: "Note: {{ item.item }} not available (possibly not built for {{ ansible_facts['architecture'] }})"
  loop: "{{ flatpak_result.results }}"
  when: item.failed | default(false)
  loop_control:
    label: "{{ item.item }}"

- name: Display Flatpak installation complete
  ansible.builtin.debug:
    msg: |
      Flatpak apps installed:
      {% for app in flatpak_apps %}
      - {{ app }}
      {% endfor %}

      Optional apps (use --tags flatpak-optional):
      {% for app in flatpak_apps_optional %}
      - {{ app }}
      {% endfor %}
