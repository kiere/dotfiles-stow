---
# Ruby installation via mise
# Supports: All distros (uses mise)

- name: Install Ruby via mise ({{ mise_ruby_version }})
  ansible.builtin.command:
    cmd: mise use --global ruby@{{ mise_ruby_version }}
  register: ruby_install
  changed_when: "'installed' in ruby_install.stdout or 'ruby@' in ruby_install.stdout"
  environment:
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:{{ user_home }}/.local/bin"

- name: Install additional Ruby version ({{ mise_ruby_additional }})
  ansible.builtin.command:
    cmd: mise install ruby@{{ mise_ruby_additional }}
  register: ruby_additional_install
  changed_when: "'installed' in ruby_additional_install.stdout"
  when: mise_ruby_additional is defined
  environment:
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:{{ user_home }}/.local/bin"

- name: Install bundler gem
  ansible.builtin.command:
    cmd: mise exec ruby -- gem install bundler
  register: ruby_bundler_install
  changed_when: "'Successfully installed' in ruby_bundler_install.stdout"
  environment:
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:{{ user_home }}/.local/bin"

- name: Install Rails gem
  ansible.builtin.command:
    cmd: mise exec ruby -- gem install rails
  register: ruby_rails_install
  changed_when: "'Successfully installed' in ruby_rails_install.stdout"
  environment:
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:{{ user_home }}/.local/bin"

- name: Display Ruby installation complete
  ansible.builtin.debug:
    msg: |
      Ruby {{ mise_ruby_version }} installed via mise!
      - Additional version: {{ mise_ruby_additional | default('none') }}
      - Bundler and Rails gems installed
