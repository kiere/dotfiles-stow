#!/bin/bash
# Create a web app launcher for any URL using Brave browser
set -e

APPS_DIR="$HOME/.local/share/applications"
ICONS_DIR="$APPS_DIR/icons"

mkdir -p "$ICONS_DIR"

if [ "$#" -lt 2 ]; then
  echo -e "\e[32mCreate a web app launcher for any URL.\n\e[0m"
  APP_NAME=$(gum input --prompt "Name> " --placeholder "My Web App")
  APP_URL=$(gum input --prompt "URL> " --placeholder "https://example.com")
  ICON_REF=$(gum input --prompt "Icon (URL or path)> " --placeholder "https://example.com/icon.png (optional)")
else
  APP_NAME="$1"
  APP_URL="$2"
  ICON_REF="${3:-}"
fi

if [[ -z "$APP_NAME" || -z "$APP_URL" ]]; then
  echo "Error: Name and URL are required."
  exit 1
fi

# Sanitize app name for filename (replace spaces with dashes, lowercase)
APP_ID=$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')

# Handle icon
if [[ -n "$ICON_REF" ]]; then
  if [[ "$ICON_REF" =~ ^https?:// ]]; then
    # Detect extension from URL, default to png
    if [[ "$ICON_REF" =~ \.svg($|\?) ]]; then
      EXT="svg"
    else
      EXT="png"
    fi
    ICON_PATH="$ICONS_DIR/$APP_ID.$EXT"
    echo "Downloading icon..."
    if ! curl -sL -o "$ICON_PATH" "$ICON_REF"; then
      echo "Warning: Failed to download icon, using default."
      ICON_PATH="brave-browser"
    fi
  elif [[ -f "$ICON_REF" ]]; then
    ICON_PATH="$ICON_REF"
  else
    ICON_PATH="brave-browser"
  fi
else
  ICON_PATH="brave-browser"
fi

# Create .desktop file
DESKTOP_FILE="$APPS_DIR/$APP_ID.desktop"

cat > "$DESKTOP_FILE" <<EOF
[Desktop Entry]
Version=1.0
Name=$APP_NAME
Comment=$APP_NAME web app
Exec=brave-browser --app=$APP_URL
Terminal=false
Type=Application
Icon=$ICON_PATH
StartupNotify=true
Categories=Network;WebApp;
EOF

chmod +x "$DESKTOP_FILE"

# Update desktop database so it appears immediately
update-desktop-database "$APPS_DIR" 2>/dev/null || true

echo -e "\n\e[32mCreated: $DESKTOP_FILE\e[0m"
echo "You can now find '$APP_NAME' in your app launcher."
